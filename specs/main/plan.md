# Implementation Plan: Better Auth Authentication System Rebuild

**Branch**: `main` | **Date**: 2025-12-17 | **Spec**: Authentication System
**Input**: Rebuild broken custom auth with Better Auth framework

## Summary

Replace the broken custom authentication system with **Better Auth**, a production-grade authentication framework supporting session persistence, two-step signup flow, and protected content access. The implementation includes:

1. **Complete custom auth cleanup** (delete broken logic, migrate to Better Auth)
2. **Better Auth server setup** with PostgreSQL and Neon database
3. **Two-step personalized signup** (identity + hardware/software questionnaire)
4. **Session persistence** (users stay logged in across sessions)
5. **Content guarding** (redirect unauthenticated users from course content)
6. **Header fixes** (Sign In/Sign Up buttons visible left of GitHub icon)

This work earns the **50-point authentication bonus** and fixes persistent "failed to fetch" errors from the broken implementation.

## Technical Context

**Language/Version**: TypeScript (Frontend), Python 3.10+ (Backend), Node.js 18+ (Auth Server)
**Primary Dependencies**:
  - Frontend: better-auth (client), Zustand (state), React/Docusaurus
  - Backend: FastAPI, python-jose (JWT validation)
  - Auth: Better Auth (Node.js server), PostgreSQL + Neon
**Storage**: Neon PostgreSQL (shared database for auth + app data)
**Testing**: pytest (backend), Jest (frontend), manual E2E testing
**Target Platform**: Vercel (deployment)
**Project Type**: Web application (frontend + backend + auth server)
**Performance Goals**: Auth response < 200ms p95 latency
**Constraints**: Bcrypt max 72 bytes, JWT 1-hour expiration, Better Auth 7-day sessions
**Scale/Scope**: Hackathon single-project, ~10k LOC, 5 main screens (Home, Signin, Signup Step 1, Signup Step 2, Profile)

## Constitution Check

*GATE: Must pass before Phase 1 design. Re-check after implementation.*

✅ **Technology Stack (Principle II)**
- Better Auth ✅ (required)
- FastAPI + Python 3.10+ ✅
- React/Docusaurus ✅
- Neon Postgres ✅
- Vercel deployment ✅

✅ **Feature Completeness (Principle III)**
- User authentication via Better Auth ✅
- Personalization features (two-step signup) ✅
- Session persistence ✅
- Content guarding (protected routes) ✅
- Bonus features support ✅

✅ **Code Quality Standards (Principle IV)**
- TypeScript strict mode ✅
- Python type hints + mypy ✅
- Error handling with user-friendly messages ✅
- No hardcoded secrets (env vars) ✅

✅ **Integration Architecture (Principle V)**
- RESTful API contracts ✅
- JWT token validation in FastAPI ✅
- CORS configured ✅
- Session state in Postgres ✅

✅ **Security & Privacy (Principle VIII)**
- Bcrypt password hashing (12+ rounds) ✅
- JWT 1-hour expiration ✅
- HTTPS enforced (Vercel) ✅
- Input validation on all endpoints ✅

✅ **Simplicity & Pragmatism (Principle IX)**
- No over-engineering ✅
- Focused on requirements only ✅
- No speculative features ✅

**GATE STATUS**: ✅ PASS - All principles satisfied

## Project Structure

### Documentation (this feature)

```text
specs/main/
├── plan.md              # This file (architecture + design decisions)
├── research.md          # Research findings on Better Auth patterns
├── data-model.md        # User + Session data models
├── contracts/           # API endpoint contracts
│   ├── auth-endpoints.md
│   └── profile-endpoints.md
├── quickstart.md        # Setup and configuration guide
└── tasks.md             # Implementable tasks (generated by /sp.tasks)
```

### Source Code Structure (Web Application)

```text
frontend/
├── src/
│   ├── pages/
│   │   ├── signin.tsx          # Sign In page
│   │   ├── signup.tsx          # Sign Up Step 1 (Identity)
│   │   ├── signup-step2.tsx   # Sign Up Step 2 (Questionnaire)
│   │   ├── profile.tsx         # User Profile page
│   │   └── course.tsx          # Protected course content
│   ├── components/
│   │   ├── Auth/
│   │   │   ├── ProtectedRoute.tsx      # Auth guard component
│   │   │   ├── SignInForm.tsx          # FIXED: proper error handling
│   │   │   ├── SignUpForm.tsx          # FIXED: proper error handling
│   │   │   └── QuestionnaireForm.tsx   # NEW: background data collection
│   │   └── Navigation/
│   │       └── NavBar.tsx      # FIXED: Sign In/Sign Up buttons visible
│   ├── services/
│   │   ├── betterAuthService.ts        # FIXED: proper error handling
│   │   ├── api.ts                      # FIXED: proper error handling
│   │   └── authService.ts              # To be deprecated (cleanup)
│   ├── store/
│   │   └── authStore.ts        # Zustand auth state (uses Better Auth client)
│   ├── lib/
│   │   └── auth-client.ts      # Better Auth client initialization
│   └── theme/
│       ├── Root.tsx             # NEW: Docusaurus Root for auth providers
│       └── Navbar/
│           ├── index.tsx        # FIXED: restore sign in/up buttons
│           └── styles.css       # FIXED: proper styling for visibility

backend/
├── src/
│   ├── api/
│   │   └── routes/
│   │       ├── auth.py         # FIXED: Better Auth integration
│   │       └── profile.py      # NEW: Profile update endpoint
│   ├── middleware/
│   │   └── auth.py             # FIXED: Better Auth JWT validation
│   ├── services/
│   │   ├── auth_service.py     # CLEANUP: remove broken custom auth
│   │   └── user_service.py     # NEW: user profile management
│   ├── models/
│   │   ├── user.py             # User model from Better Auth
│   │   └── chat_session.py     # Chat history (existing)
│   └── core/
│       └── config.py           # FIXED: add BETTER_AUTH_SECRET config

auth-server/
├── auth.js                      # Better Auth server (uses existing config)
├── package.json
└── .env                         # Better Auth secrets
```

**Structure Decision**: Web application with three separate services:
1. **Frontend** (Docusaurus + React) on port 3000
2. **Backend** (FastAPI) on port 8000
3. **Auth Server** (Better Auth) on port 5000

All three share the same Neon PostgreSQL database. This separation follows your existing architecture and matches the constitution requirements.

## Data Model & Architecture

### Key Entities

**User** (from Better Auth)
```
- id: UUID (Better Auth managed)
- email: string (unique)
- password: hashed by bcrypt (max 72 bytes)
- name: string
- image?: string
- emailVerified: boolean
- createdAt: timestamp
- updatedAt: timestamp

// Custom fields for personalization
- ros2_experience: string (e.g., "Beginner", "Intermediate", "Expert")
- gpu_model: string (e.g., "NVIDIA RTX 4090")
- gpu_vram: string (e.g., "24GB")
- operating_system: string (e.g., "Ubuntu 22.04")
- robotics_knowledge: string (e.g., "None", "Basic", "Advanced")
```

**Session** (from Better Auth)
```
- id: string (unique)
- userId: UUID (foreign key to User)
- token: JWT (HS256 signed with BETTER_AUTH_SECRET)
- expiresAt: timestamp
- createdAt: timestamp

Persistence: 7 days, with cookie cache refresh every 1 day
```

### Integration Points

**Frontend ↔ Auth Server**
- endpoint: `http://localhost:5000/api/auth/sign-up/email`
- endpoint: `http://localhost:5000/api/auth/sign-in/email`
- endpoint: `http://localhost:5000/api/auth/sign-out`
- endpoint: `http://localhost:5000/api/auth/get-session`
- protocol: REST + cookies (credentials: 'include')
- auth: Session cookie (httpOnly, secure on production)

**Frontend ↔ Backend**
- endpoint: `http://localhost:8000/api/v1/chat` (requires Bearer token)
- endpoint: `http://localhost:8000/api/v1/search` (requires Bearer token)
- endpoint: `http://localhost:8000/api/v1/auth/profile` (requires Bearer token)
- protocol: REST + Bearer JWT
- auth: Authorization header with Better Auth JWT token

**Backend ↔ Database**
- Validates JWT tokens using same `BETTER_AUTH_SECRET`
- Reads/writes user profile data (ros2_experience, gpu_model, etc.)
- Maintains chat history isolation per user

### Authentication Flow (Happy Path)

1. **Sign Up - Step 1 (Identity)**
   - User enters email, password (validated: 8-72 bytes)
   - Frontend calls `/api/auth/sign-up/email` on auth-server
   - Better Auth hashes password with bcrypt, creates user, returns session + JWT
   - Frontend stores JWT in Zustand + localStorage

2. **Sign Up - Step 2 (Questionnaire)**
   - User answers: ROS2 experience, GPU model, VRAM, OS, robotics knowledge
   - Frontend calls `PATCH /api/v1/auth/profile` on backend with Bearer JWT
   - Backend validates token, updates user record with background data
   - User is now fully onboarded

3. **Session Persistence**
   - JWT stored in cookie (by Better Auth) and localStorage (by Zustand)
   - On page reload, Zustand restores auth state from localStorage
   - Better Auth validates session with auth-server on app boot
   - User stays logged in for 7 days (session expiration)

4. **Protected Access**
   - User clicks "Course Content" or "Start Learning"
   - ProtectedRoute component checks `isAuthenticated` in Zustand
   - If not authenticated → redirect to `/signin`
   - If authenticated → render course content + chat widget
   - All API calls include Bearer token in Authorization header

5. **Sign Out**
   - User clicks "Sign Out" button
   - Frontend calls `/api/auth/sign-out` on auth-server
   - Frontend clears Zustand state and localStorage
   - Redirect to home page

## API Contracts

### Auth Endpoints (Better Auth Server)

**POST /api/auth/sign-up/email**
```
Request:
{
  "email": "user@example.com",
  "password": "SecurePass123!",  // 8-72 bytes validated on frontend
  "name": "John Doe"
}

Response (201 Created):
{
  "session": {
    "token": "eyJhbGc...",  // JWT (HS256)
    "expiresAt": "2025-12-24T10:00:00Z",
    "userId": "uuid-here"
  },
  "user": {
    "id": "uuid-here",
    "email": "user@example.com",
    "name": "John Doe",
    "emailVerified": false
  }
}

Errors:
- 400: Invalid email format, password too short/long, user exists
- 500: Database error
```

**POST /api/auth/sign-in/email**
```
Request:
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

Response (200 OK):
{
  "session": { ... },  // Same as sign-up
  "user": { ... }
}

Errors:
- 401: Invalid credentials
- 404: User not found
- 500: Database error
```

**POST /api/auth/sign-out**
```
Request: (requires session cookie)

Response (200 OK):
{ "success": true }

Errors:
- 401: No valid session
- 500: Database error
```

**GET /api/auth/get-session**
```
Response (200 OK):
{
  "session": { ... },
  "user": { ... }
}

Response (401 Unauthorized):
null  // No active session
```

### Backend Endpoints (FastAPI)

**PATCH /api/v1/auth/profile**
```
Request (requires Bearer JWT):
{
  "ros2_experience": "Beginner",
  "gpu_model": "NVIDIA RTX 4090",
  "gpu_vram": "24GB",
  "operating_system": "Ubuntu 22.04",
  "robotics_knowledge": "Basic"
}

Response (200 OK):
{
  "id": "uuid-here",
  "email": "user@example.com",
  "name": "John Doe",
  "ros2_experience": "Beginner",
  "gpu_model": "NVIDIA RTX 4090",
  ...
}

Errors:
- 401: Invalid/missing Bearer token
- 400: Invalid field values
- 500: Database error
```

**GET /api/v1/chat, POST /api/v1/search**
```
Request (requires Bearer JWT in header):
Authorization: Bearer <jwt-token>

Response: (existing RAG endpoints)
```

## Implementation Strategy

### Phase 1: Clean Slate (Cleanup)

1. **Delete broken custom auth**
   - Remove `/backend/src/services/auth_service.py` (broken password hashing)
   - Remove `/backend/src/api/routes/auth.py` (old endpoints)
   - Remove `/frontend/src/services/authService.ts` (old endpoints)
   - Remove `/frontend/src/pages/signin.tsx` (old form)
   - Remove `/frontend/src/pages/signup.tsx` (old form)

2. **Keep existing infrastructure**
   - Auth server at `auth-server/` (already configured)
   - Better Auth client at `frontend/src/lib/auth-client.ts` (already exists)
   - Zustand store at `frontend/src/store/authStore.ts` (already exists)

### Phase 2: Fix Frontend Error Handling

1. Update error handling in `/frontend/src/services/betterAuthService.ts` (DONE in previous task)
2. Update error handling in `/frontend/src/services/api.ts` (DONE in previous task)
3. Restore Sign In/Sign Up buttons in navbar
4. Fix header styling to show buttons left of GitHub icon

### Phase 3: Implement Two-Step Signup

1. Create `/frontend/src/pages/signup.tsx` with Step 1 (identity)
2. Create `/frontend/src/components/Auth/QuestionnaireForm.tsx` for Step 2
3. Create flow: signup step 1 → success → auto-redirect to step 2
4. Step 2 calls `PATCH /api/v1/auth/profile` to save background data

### Phase 4: Implement Content Guarding

1. Create `/frontend/src/components/Auth/ProtectedRoute.tsx`
2. Create `/frontend/src/pages/course.tsx` (protected)
3. Update homepage: "Course Content" button → check auth → redirect if needed
4. Add protection to all RAG chat endpoints on backend

### Phase 5: Backend Profile Updates

1. Create `/backend/src/api/routes/profile.py` with PATCH endpoint
2. Create `/backend/src/services/user_service.py` for profile updates
3. Add middleware to validate Better Auth JWT tokens
4. Update user model to support custom fields

### Phase 6: Testing & Deployment

1. Manual E2E testing of signup flow
2. Test session persistence across browser restarts
3. Test content protection (redirect unauthenticated users)
4. Deploy to Vercel and test production auth-server connectivity

## Complexity Tracking

*No constitution violations. All principles satisfied.*

| Item | Status | Notes |
|------|--------|-------|
| Technology Stack | ✅ Compliant | Better Auth + FastAPI + React/Docusaurus |
| Feature Completeness | ✅ Compliant | All 50-point bonus features included |
| Code Quality | ✅ Compliant | Type hints, error handling, no secrets in code |
| Integration | ✅ Compliant | JWT + REST API contracts well-defined |
| Simplicity | ✅ Compliant | Focused on requirements, no over-engineering |

## Next Steps

1. **Phase 0 Complete**: Research ✅ done
2. **Phase 1 Complete**: Design (this plan) ✅ done
3. **Phase 2 (Ready)**: Generate `/sp.tasks` to create implementation tasks
   - Run: `/sp.tasks`
   - This will create actionable, dependency-ordered tasks for each phase

---

**Plan Status**: Ready for task generation and implementation
**Estimated Work**: 6-8 hours across all phases
**Key Success Metrics**:
- ✅ All "failed to fetch" errors resolved
- ✅ Users stay logged in across sessions (7 days)
- ✅ Two-step signup completes with background data
- ✅ Unauthenticated users redirected from course content
- ✅ Sign In/Sign Up buttons visible in header
- ✅ All code follows constitution standards
